<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de encuestas ‚Äî Omomobility</title>
  <link rel="icon" href="logcho.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="listadeencuestas.css" />


</head>
<body>
  <div class="page">
    <header class="header" style="position: relative;">
      <img class="logo" src="logcho.png" alt="Omomobility" onerror="this.onerror=null; this.src='logch.png'"/>
      <div>
        <h1>Lista de encuestas</h1>
        <p class="lead">Consulta y gestiona hasta 250 encuestas desde Firebase (fallback: este dispositivo).</p>      </div>
      <div id="roleBadge" class="header-actions"></div>
    </header>

        <!-- Panel de estad√≠sticas de Firebase -->
        <div class="stats-panel">
          <h3>üìä Uso de Firebase</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total de encuestas</div>
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-subtext">L√≠mite: 250</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-surveys" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Almacenamiento usado</div>
              <div class="stat-value" id="stat-storage">0 MB</div>
              <div class="stat-subtext">L√≠mite gratuito: 1 GB</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-storage" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Con evidencia fotogr√°fica</div>
              <div class="stat-value" id="stat-images">0</div>
              <div class="stat-subtext" id="stat-images-percent">0% del total</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">√öltima actualizaci√≥n</div>
              <div class="stat-value" style="font-size: 16px;" id="stat-updated">‚Äî</div>
              <div class="stat-subtext">Tiempo real</div>
            </div>
          </div>
        </div>

    <div class="toolbar">
      <input id="search" class="search" type="text" placeholder="Buscar por encuestador, zona, comentarios..." />
      <select id="pageSize" class="btn outline small">
        <option value="25">25 por p√°gina</option>
        <option value="50" selected>50 por p√°gina</option>
        <option value="100">100 por p√°gina</option>
      </select>
      <span id="countInfo" class="note"></span>
      <div class="header-actions">
        <a href="index.html" class="btn outline small">‚Üê Inicio</a>
        <a href="encuesta.html" class="btn small">Nueva encuesta</a>
      </div>
    </div>

    <button id="exportCsv" class="btn outline small">Exportar CSV</button>
<label class="btn outline small" style="cursor:pointer;">
  Importar CSV
  <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none;">
</label>

<!-- Leyenda de encuestadores -->
<div class="encuestadores-legend">
  <span class="legend-title">Encuestadores:</span>
  <div class="legend-item">
    <span class="legend-badge avatar maximo">MX</span>
    <span>M√°ximo Garc√≠a</span>
  </div>
  <div class="legend-item">
    <span class="legend-badge avatar humberto">HU</span>
    <span>Humberto Castillo</span>
  </div>
  <div class="legend-item">
    <span class="legend-badge avatar aristides">AR</span>
    <span>Ar√≠stides Prats</span>
  </div>
</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w160 sortable" data-sort="ts">Fecha</th>
            <th class="sortable" data-sort="encuestador_id">Encuestador</th>
            <th class="sortable" data-sort="zona">Zona</th>
            <th class="w100 sortable" data-sort="edad">Edad</th>
            <th class="w100 sortable" data-sort="intencion">Intenci√≥n</th>
            <th class="w120">Ubicaci√≥n</th>
            <th>Evidencia</th>
            <th class="w160">Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="pagination">
        <button id="prev" class="btn outline small">Anterior</button>
        <span id="pageInfo" class="note"></span>
        <button id="next" class="btn outline small">Siguiente</button>
      </div>
    </div>
  </div>

  <dialog id="viewModal">
    <div class="modal">
      <h3>Detalle de encuesta</h3>
      <div id="detail"></div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('viewModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>
  <dialog id="imageModal">
    <div class="modal">
      <h3>Evidencia</h3>
      <div class="img-wrap" id="imageWrap"></div>
      <div class="detail" style="margin-top: 10px;">
        <div class="kv">
          <label>Encuestador</label>
          <div class="val" id="img_encuestador">‚Äî</div>
        </div>
        <div class="kv">
          <label>Fecha</label>
          <div class="val" id="img_fecha">‚Äî</div>
        </div>
        <div class="kv">
          <label>Ubicaci√≥n</label>
          <div class="val mono" id="img_geo">‚Äî</div>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('imageModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <dialog id="editModal">
    <div class="modal">
      <h3>Editar encuesta</h3>
      <div class="grid-2">
        <div class="field">
          <label>Edad</label>
          <input id="edit_edad" type="number" min="15" max="80"/>
        </div>
        <div class="field">
          <label>Intenci√≥n (0‚Äì10)</label>
          <input id="edit_intencion" type="number" min="0" max="10"/>
        </div>
        <div class="field">
          <label>Zona</label>
          <input id="edit_zona" type="text" />
        </div>
        <div class="field">
          <label>Comentarios</label>
          <textarea id="edit_comentarios" rows="2"></textarea>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn outline" onclick="document.getElementById('editModal').close()">Cancelar</button>
        <button id="saveEdit" class="btn">Guardar</button>
      </div>
    </div>
  </dialog>
    <!-- Firebase y dependencias -->
    <script src="data-manager.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
  
    <!-- Scripts de la p√°gina -->
    <script src="listadeencuestas-core.js"></script>
    <script src="real-time-updates.js"></script>
  
    <!-- Badge de estado Firebase -->
    <script>
      (function firebaseStatusBadge(){
        function ensureBadge() {
          const header = document.querySelector('.header') || document.body;
          if (!header) return;
          let el = document.getElementById('fb-status-badge');
          if (!el) {
            el = document.createElement('div');
            el.id = 'fb-status-badge';
            el.style.cssText = `
              position:absolute; top:10px; right:20px; z-index:9999;
              display:flex; align-items:center; gap:8px;
              background: rgba(255,255,255,0.95); border:1px solid #e5e7eb;
              padding:6px 10px; border-radius:999px; font: 12px Inter, sans-serif;
              box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            `;
            header.style.position = 'relative';
            header.appendChild(el);
          }
          const ok = !!(window.db && window.fbAuth && window.fbAuth.currentUser);
          const email = window.fbAuth?.currentUser?.email || '‚Äî';
          el.innerHTML = `
            <span style="width:10px;height:10px;border-radius:999px;background:${ok ? '#16a34a' : '#ef4444'};display:inline-block;"></span>
            <span>${ok ? 'Firebase: Online' : 'Firebase: Offline'}</span>
            <span style="color:#64748b">(${email})</span>
          `;
        }
        const deadline = Date.now() + 5000;
        (function tick(){
          ensureBadge();
          if (Date.now() < deadline && !(window.fbAuth && window.fbAuth.currentUser)) {
            setTimeout(tick, 300);
          }
        })();
        if (window.fbAuth?.onAuthStateChanged) {
          window.fbAuth.onAuthStateChanged(() => ensureBadge());
        }
      })();
    </script>
  </body>
  </html>