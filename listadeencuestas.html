<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de encuestas ‚Äî Omomobility</title>
  <link rel="icon" href="logcho.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 16px 0; }
    .search { min-width: 220px; }
  
    /* Tabla mejorada */
    table { width: 100%; border-collapse: collapse; background: var(--paper); border-radius: 12px; overflow: hidden; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { position: sticky; top: 0; z-index: 1; text-align: left; font-weight: 600; color: var(--muted); background: #f7f7f7; backdrop-filter: blur(4px); }
    tbody tr:nth-child(odd) { background: #fcfcfc; }
    tbody tr:hover { background: #fffbe6; }
  
    .actions { display: flex; gap: 6px; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .role-admin { background: #dc35451a; color: #dc3545; }
    .role-supervisor { background: #0d6efd1a; color: #0d6efd; }
    .role-encuestador { background: #6c757d1a; color: #6c757d; }
  
    .pagination { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    .muted { color: var(--muted); }
    .nowrap { white-space: nowrap; }
    .w100 { width: 100px; } .w120 { width: 120px; } .w160 { width: 160px; }
  
    /* Evidencia */
    .thumb { max-width: 120px; max-height: 80px; border: 1px solid var(--border); border-radius: 8px; transition: transform .15s ease, box-shadow .15s ease; }
    .thumb:hover { transform: scale(1.4); box-shadow: 0 6px 18px rgba(0,0,0,.15); }
  
    /* Celdas mejoradas */
    .cell-user { display: flex; align-items: center; gap: 8px; }
    .avatar {
      width: 28px; height: 28px; border-radius: 999px;
      background: #eef2ff; color: #4f46e5; font-weight: 700;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 12px; border: 1px solid #e5e7eb;
    }
    .chip {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      background: #f0fdf4; color: #16a34a; font-size: 12px; border: 1px solid #e2e8f0;
    }
    .num { text-align: center; font-variant-numeric: tabular-nums; }
    .geo { color: #64748b; font-size: 12px; }
  
    /* Barra de intenci√≥n mini */
    .intent {
      display: inline-flex; align-items: center; gap: 6px;
    }
    .intent-bar {
      width: 90px; height: 8px; border-radius: 999px; background: #e5e7eb; overflow: hidden; border: 1px solid #e2e8f0;
    }
    .intent-fill {
      height: 100%; background: linear-gradient(90deg, #34d399, #10b981);
      width: 0%;
    }
    /* Encabezados ordenables */
th.sortable {
  cursor: pointer;
  user-select: none;
  transition: background 0.2s ease;
}
th.sortable:hover {
  background: #e5e7eb;
}
th.sortable::after {
  content: ' ‚Üï';
  opacity: 0.3;
  font-size: 12px;
}
th.sortable.sort-asc::after {
  content: ' ‚Üë';
  opacity: 1;
  color: #4f46e5;
}
th.sortable.sort-desc::after {
  content: ' ‚Üì';
  opacity: 1;
  color: #4f46e5;
}
    /* Panel de estad√≠sticas de Firebase */
    .stats-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .stats-panel h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .stat-subtext {
      font-size: 11px;
      opacity: 0.8;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34d399, #10b981);
      border-radius: 999px;
      transition: width 0.3s ease;
    }
    .progress-fill.warning {
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }
    .progress-fill.danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header" style="position: relative;">
      <img class="logo" src="logcho.png" alt="Omomobility" onerror="this.onerror=null; this.src='logch.png'"/>
      <div>
        <h1>Lista de encuestas</h1>
        <p class="lead">Consulta y gestiona hasta 250 encuestas desde Firebase (fallback: este dispositivo).</p>      </div>
      <div id="roleBadge" class="header-actions"></div>
    </header>

        <!-- Panel de estad√≠sticas de Firebase -->
        <div class="stats-panel">
          <h3>üìä Uso de Firebase</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total de encuestas</div>
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-subtext">L√≠mite: 250</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-surveys" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Almacenamiento usado</div>
              <div class="stat-value" id="stat-storage">0 MB</div>
              <div class="stat-subtext">L√≠mite gratuito: 1 GB</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-storage" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Con evidencia fotogr√°fica</div>
              <div class="stat-value" id="stat-images">0</div>
              <div class="stat-subtext" id="stat-images-percent">0% del total</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">√öltima actualizaci√≥n</div>
              <div class="stat-value" style="font-size: 16px;" id="stat-updated">‚Äî</div>
              <div class="stat-subtext">Tiempo real</div>
            </div>
          </div>
        </div>

    <div class="toolbar">
      <input id="search" class="search" type="text" placeholder="Buscar por encuestador, zona, comentarios..." />
      <select id="pageSize" class="btn outline small">
        <option value="25">25 por p√°gina</option>
        <option value="50" selected>50 por p√°gina</option>
        <option value="100">100 por p√°gina</option>
      </select>
      <span id="countInfo" class="note"></span>
      <div class="header-actions">
        <a href="index.html" class="btn outline small">‚Üê Inicio</a>
        <a href="encuesta.html" class="btn small">Nueva encuesta</a>
      </div>
    </div>

    <button id="exportCsv" class="btn outline small">Exportar CSV</button>
<label class="btn outline small" style="cursor:pointer;">
  Importar CSV
  <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none;">
</label>

<!-- Leyenda de encuestadores -->
<div class="encuestadores-legend">
  <span class="legend-title">Encuestadores:</span>
  <div class="legend-item">
    <span class="legend-badge avatar maximo">MX</span>
    <span>M√°ximo Garc√≠a</span>
  </div>
  <div class="legend-item">
    <span class="legend-badge avatar humberto">HU</span>
    <span>Humberto Castillo</span>
  </div>
  <div class="legend-item">
    <span class="legend-badge avatar aristides">AR</span>
    <span>Ar√≠stides Prats</span>
  </div>
</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w160 sortable" data-sort="ts">Fecha</th>
            <th class="sortable" data-sort="encuestador_id">Encuestador</th>
            <th class="sortable" data-sort="zona">Zona</th>
            <th class="w100 sortable" data-sort="edad">Edad</th>
            <th class="w100 sortable" data-sort="intencion">Intenci√≥n</th>
            <th class="w120">Ubicaci√≥n</th>
            <th>Evidencia</th>
            <th class="w160">Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="pagination">
        <button id="prev" class="btn outline small">Anterior</button>
        <span id="pageInfo" class="note"></span>
        <button id="next" class="btn outline small">Siguiente</button>
      </div>
    </div>
  </div>

  <dialog id="viewModal">
    <div class="modal">
      <h3>Detalle de encuesta</h3>
      <div id="detail"></div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('viewModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>
  <dialog id="imageModal">
    <div class="modal">
      <h3>Evidencia</h3>
      <div class="img-wrap" id="imageWrap"></div>
      <div class="detail" style="margin-top: 10px;">
        <div class="kv">
          <label>Encuestador</label>
          <div class="val" id="img_encuestador">‚Äî</div>
        </div>
        <div class="kv">
          <label>Fecha</label>
          <div class="val" id="img_fecha">‚Äî</div>
        </div>
        <div class="kv">
          <label>Ubicaci√≥n</label>
          <div class="val mono" id="img_geo">‚Äî</div>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('imageModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <dialog id="editModal">
    <div class="modal">
      <h3>Editar encuesta</h3>
      <div class="grid-2">
        <div class="field">
          <label>Edad</label>
          <input id="edit_edad" type="number" min="15" max="80"/>
        </div>
        <div class="field">
          <label>Intenci√≥n (0‚Äì10)</label>
          <input id="edit_intencion" type="number" min="0" max="10"/>
        </div>
        <div class="field">
          <label>Zona</label>
          <input id="edit_zona" type="text" />
        </div>
        <div class="field">
          <label>Comentarios</label>
          <textarea id="edit_comentarios" rows="2"></textarea>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn outline" onclick="document.getElementById('editModal').close()">Cancelar</button>
        <button id="saveEdit" class="btn">Guardar</button>
      </div>
    </div>
  </dialog>

  <script src="data-manager.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Config e inicializaci√≥n -->
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script>
  (function() {
    const MAX = 250; // mostrar m√°ximo 250
    const state = {
      role: 'encuestador',
      page: 1,
      pageSize: 50,
      filtered: [],
      all: [],
      editIndex: null,
      sortColumn: 'ts',
      sortDirection: 'desc' // desc = m√°s reciente primero
    };

    function getRoleBadge(role) {
      const cls = role === 'admin' ? 'role-admin' : role === 'supervisor' ? 'role-supervisor' : 'role-encuestador';
      return '<span class="pill ' + cls + '">' + role + '</span>';
    }

    function canView(role) { return ['admin', 'supervisor', 'encuestador'].includes(role); }
    function canEdit(role) { return role === 'admin'; }
    function canDelete(role) { return role === 'admin'; }

    function loadSession() {
  const prev = state.role;
  let role = 'encuestador';

  try {
    if (window.AuthSystem && typeof AuthSystem.getSession === 'function') {
      const s = AuthSystem.getSession();
      if (s?.role) role = s.role;
      if ((s?.username || '').toLowerCase() === 'admin') {
        role = 'admin';
      }
    } else {
      // fallback al localStorage directo
      const raw = localStorage.getItem('omomobility_session');
      if (raw) {
        const sess = JSON.parse(raw);
        role = sess?.role || role;
        if ((sess?.username || '').toLowerCase() === 'admin') {
          role = 'admin';
        }
      }
    }
  } catch(_) {}

  state.role = role;

  const badge = document.getElementById('roleBadge');
  if (badge) {
    badge.innerHTML = '<span class="muted">Rol:</span> ' + getRoleBadge(state.role);
  }

  if (state.role !== prev) {
    render();
  }
}

function loadData() {
  if (!window.db) {
    console.error('[Dashboard] Firebase no disponible');
    alert('Firebase no est√° disponible. Verifica tu conexi√≥n a internet.');
    state.all = [];
    applyFilter();
    return;
  }

  fetchFromFirestore().then(rows => {
    if (Array.isArray(rows)) {
      state.all = rows.slice(0, MAX);
      applyFilter();
      updateFirebaseStats(); // ‚Üê AGREGAR ESTA L√çNEA
      console.log(`[Dashboard] Cargadas ${rows.length} encuestas desde Firestore`);
    } else {
      state.all = [];
      applyFilter();
    }
  }).catch((err) => {
    console.error('[Dashboard] Error cargando desde Firestore:', err);
    alert('Error al cargar encuestas desde Firebase. Verifica tu conexi√≥n.');
    state.all = [];
    applyFilter();
  });
}


async function fetchFromFirestore() {
  try {
    const colRef = window.db.collection('surveys');
    const snap = await colRef.limit(250).get();
    const rows = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      if (d._probe) return; // omitir registros de prueba

      rows.push({
        // CR√çTICO: Guardar el ID del documento de Firestore
        _firestoreId: doc.id,
        // fecha normalizada
        ts: d.ts || d._createdAt || d.when || null,
        // campos est√°ndar del formulario
        encuestador_id: d.encuestador_id || '',
        zona: d.zona || 'Sin especificar',
        edad: d.edad ?? '',
        intencion: d.intencion ?? '',
        comentarios: d.comentarios || '',
        // geolocalizaci√≥n
        geo_lat: d.geo_lat ?? null,
        geo_lng: d.geo_lng ?? null,
        geo_accuracy: d.geo_accuracy ?? null,
        // evidencia
        image_proof_png: d.image_proof_png || null,
        // deja pasar cualquier otro campo que uses
        ...d
      });
    });
    
// DEBUGGING: Ver qu√© encuestadores est√°n en Firebase
const uniqueEncuestadores = [...new Set(rows.map(r => r.encuestador_id))];
console.log('üîç Encuestadores √∫nicos en Firebase:', uniqueEncuestadores);
console.log('üìä Distribuci√≥n:', uniqueEncuestadores.map(enc => ({
  encuestador: enc,
  cantidad: rows.filter(r => r.encuestador_id === enc).length
})));

// NUEVO: Ver si hay emails o createdBy
const uniqueEmails = [...new Set(rows.map(r => r._createdEmail).filter(Boolean))];
const uniqueCreatedBy = [...new Set(rows.map(r => r._createdBy).filter(Boolean))];
console.log('üìß Emails √∫nicos (_createdEmail):', uniqueEmails);
console.log('üë§ CreatedBy √∫nicos (_createdBy):', uniqueCreatedBy);
    
    console.log('[Dashboard] Firestore rows:', rows.length, rows[0] ? Object.keys(rows[0]) : 'no rows');
    return rows;
  } catch (e) {
    console.warn('Firestore read failed:', e?.message || e);
    return [];
  }
}


function updateFirebaseStats() {
  const total = state.all.length;
  const maxSurveys = 250;
  
  // Calcular encuestas con im√°genes
  const withImages = state.all.filter(r => r.image_proof_png).length;
  
  // Estimar tama√±o de almacenamiento
  let estimatedSize = 0;
  state.all.forEach(r => {
    // Tama√±o base del documento (campos de texto): ~2KB
    estimatedSize += 2;
    
    // Si tiene imagen, agregar tama√±o estimado de la imagen
    if (r.image_proof_png) {
      // Base64 image: aproximadamente 100-150KB por imagen
      const base64Length = r.image_proof_png.length;
      const sizeInKB = (base64Length * 0.75) / 1024; // Convertir base64 a KB real
      estimatedSize += sizeInKB;
    }
  });
  
  const estimatedMB = (estimatedSize / 1024).toFixed(2);
  const storagePercent = ((estimatedSize / 1024) / 1024 * 100).toFixed(1); // % de 1GB
  
  // Actualizar UI
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-storage').textContent = `${estimatedMB} MB`;
  document.getElementById('stat-images').textContent = withImages;
  document.getElementById('stat-images-percent').textContent = 
    total > 0 ? `${Math.round((withImages / total) * 100)}% del total` : '0% del total';
  document.getElementById('stat-updated').textContent = 
    new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
  
  // Actualizar barras de progreso
  const surveyPercent = Math.min((total / maxSurveys) * 100, 100);
  const surveyBar = document.getElementById('progress-surveys');
  surveyBar.style.width = `${surveyPercent}%`;
  
  // Cambiar color seg√∫n porcentaje
  surveyBar.className = 'progress-fill';
  if (surveyPercent > 80) surveyBar.classList.add('danger');
  else if (surveyPercent > 60) surveyBar.classList.add('warning');
  
  const storageBar = document.getElementById('progress-storage');
  storageBar.style.width = `${Math.min(storagePercent, 100)}%`;
  storageBar.className = 'progress-fill';
  if (storagePercent > 80) storageBar.classList.add('danger');
  else if (storagePercent > 60) storageBar.classList.add('warning');
  
  console.log(`[Stats] Total: ${total}, Storage: ${estimatedMB}MB, Images: ${withImages}`);
}


function applyFilter() {
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      const list = state.all.filter(r => {
        const hay = (v) => (v ?? '').toString().toLowerCase().includes(q);
        return !q ||
          hay(r.encuestador_id) ||
          hay(r.zona) ||
          hay(r.comentarios) ||
          hay(r.ts);
      });
      state.filtered = list;
      sortData(); // Ordenar despu√©s de filtrar
      state.page = 1;
      render();
      updateFirebaseStats(); // ‚Üê AGREGAR ESTA L√çNEA
    }



        // Funci√≥n para ordenar los datos
        function sortData() {
      const col = state.sortColumn;
      const dir = state.sortDirection;
      
      state.filtered.sort((a, b) => {
        let valA = a[col];
        let valB = b[col];
        
        // Manejar valores nulos/undefined
        if (valA == null) valA = '';
        if (valB == null) valB = '';
        
        // Convertir a n√∫meros si es edad o intenci√≥n
        if (col === 'edad' || col === 'intencion') {
          valA = Number(valA) || 0;
          valB = Number(valB) || 0;
        }
        
        // Comparaci√≥n para fechas
        if (col === 'ts') {
          valA = new Date(valA).getTime() || 0;
          valB = new Date(valB).getTime() || 0;
        }
        
        // Comparaci√≥n
        let comparison = 0;
        if (valA > valB) comparison = 1;
        if (valA < valB) comparison = -1;
        
        return dir === 'asc' ? comparison : -comparison;
      });
    }
    
    // Funci√≥n para cambiar columna de ordenamiento
    function setSortColumn(column) {
      if (state.sortColumn === column) {
        // Alternar direcci√≥n si es la misma columna
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        // Nueva columna, empezar descendente
        state.sortColumn = column;
        state.sortDirection = 'desc';
      }
      
      sortData();
      state.page = 1;
      render();
    }

    function paginate(arr) {
      const start = (state.page - 1) * state.pageSize;
      return arr.slice(start, start + state.pageSize);
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
    }

    function fmtGeo(r) {
      if (r.geo_lat == null || r.geo_lng == null) return '<span class="muted">N/A</span>';
      const lat = Number(r.geo_lat).toFixed(5);
      const lng = Number(r.geo_lng).toFixed(5);
      const acc = (r.geo_accuracy != null) ? ` ¬±${Math.round(r.geo_accuracy)}m` : '';
      const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
      
      return `
        <div style="display: flex; flex-direction: column; gap: 2px; font-size: 12px;">
          <span style="user-select: text; color: #64748b;">Lat: ${lat}</span>
          <span style="user-select: text; color: #64748b;">Lng: ${lng}</span>
          ${acc ? `<span style="color: #94a3b8; font-size: 11px;">${acc}</span>` : ''}
          <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" 
             class="btn outline small" 
             style="font-size: 10px; padding: 2px 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 3px; width: fit-content; margin-top: 2px;">
            üó∫Ô∏è Ver mapa
          </a>
        </div>
      `;
    }

    function getEncuestadorBadge(encuestadorId) {
  if (!encuestadorId) return { badge: 'NA', class: '' };
  
  const id = encuestadorId.toString().toLowerCase().trim();
  
  // Admin
  if (id === 'admin' || id.includes('admin')) {
    return { badge: 'AD', class: 'admin' };
  }
  
  // Supervisor
  if (id === 'supervisor' || id.includes('supervisor')) {
    return { badge: 'SU', class: 'supervisor' };
  }
  
  // M√°ximo Garc√≠a Dorame
  if (id === 'encuestador' || 
      id === 'encuestador@omobility.com' ||
      id.includes('maximo') ||
      id.includes('m√°ximo') ||
      id.includes('garcia')) {
    return { badge: 'MX', class: 'maximo' };
  }
  
  // Humberto Castillo
  if (id === 'encuestador2' || 
      id === 'encuestador2@omobility.com' ||
      id.includes('humberto') ||
      id.includes('castillo')) {
    return { badge: 'HU', class: 'humberto' };
  }
  
  // Ar√≠stides Prats
  if (id === 'encuestador3' || 
      id === 'encuestador3@omobility.com' ||
      id.includes('aristides') ||
      id.includes('ar√≠stides') ||
      id.includes('prats')) {
    return { badge: 'AR', class: 'aristides' };
  }
  
  // Default
  return { badge: id.slice(0, 2).toUpperCase(), class: '' };
}


    function render() {
      const total = state.filtered.length;
      const pages = Math.max(1, Math.ceil(total / state.pageSize));
      state.page = Math.min(state.page, pages);


      // Actualizar indicadores visuales de ordenamiento
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.getAttribute('data-sort') === state.sortColumn) {
          th.classList.add(`sort-${state.sortDirection}`);
        }
      });

      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';

      const pageRows = paginate(state.filtered);
      pageRows.forEach((r, i) => {
        const idx = (state.page - 1) * state.pageSize + i; // √≠ndice real en filtered
        // Enlace a evidencia (thumbnail inline si existe)
        const evidence = r.image_proof_png
          ? `<img class="thumb" src="${r.image_proof_png}" alt="evidencia" />`
          : `<span class="muted">Sin imagen</span>`;

        const actions = [];
        actions.push(`<button class="btn outline small" data-action="view" data-idx="${idx}">Ver</button>`);
        if (canEdit(state.role)) actions.push(`<button class="btn outline small" data-action="edit" data-idx="${idx}">Editar</button>`);
        if (canDelete(state.role)) actions.push(`<button class="btn outline small" style="color:#e53e3e;border-color:#e53e3e" data-action="delete" data-idx="${idx}">Eliminar</button>`);
        const encBadge = getEncuestadorBadge(r.encuestador_id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="nowrap">${fmtDate(r.ts)}</td>
        <td>
            <div class="cell-user">
            <span class="avatar ${encBadge.class}">${encBadge.badge}</span>
            </div>
          </td>
        <td><span class="chip">${(r.zona || 'Sin especificar')}</span></td>
        <td class="num">${r.edad ?? ''}</td>
        <td class="num">
          <div class="intent">
            <div class="intent-bar"><div class="intent-fill" style="width: ${Math.max(0, Math.min(100, Number(r.intencion || 0) * 10))}%;"></div></div>
            <span>${r.intencion ?? ''}</span>
          </div>
        </td>
        <td class="nowrap">${fmtGeo(r)}</td>
<td>
  ${r.image_proof_png
    ? `<img class="thumb" src="${r.image_proof_png}" alt="evidencia" data-action="evidence" data-idx="${idx}" />`
    : `<span class="muted">Sin imagen</span>`}
</td>        <td><div class="actions">${actions.join('')}</div></td>
      `;
        tbody.appendChild(tr);
      });

      document.getElementById('pageInfo').textContent = `P√°gina ${state.page} de ${pages}`;
      document.getElementById('countInfo').textContent = `${total} encuestas (mostrando m√°x. ${MAX})`;
      document.getElementById('prev').disabled = state.page <= 1;
      document.getElementById('next').disabled = state.page >= pages;
    }

    function wireEvents() {
      document.getElementById('search').addEventListener('input', () => applyFilter());
      document.getElementById('pageSize').addEventListener('change', (e) => {
        state.pageSize = parseInt(e.target.value, 10) || 50;
        render();
      });
      document.getElementById('prev').addEventListener('click', () => { state.page = Math.max(1, state.page - 1); render(); });
      document.getElementById('next').addEventListener('click', () => {
        const total = state.filtered.length;
        const pages = Math.max(1, Math.ceil(total / state.pageSize));
        state.page = Math.min(pages, state.page + 1);
        render();
      });  // ‚Üê Este cierra el listener de 'next'

      // Event listeners para ordenamiento de columnas
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-sort');
          if (column) setSortColumn(column);
        });
      });

      document.getElementById('rows').addEventListener('click', (e) => {
      // Click en evidencia (imagen)
      const img = e.target.closest('img.thumb[data-action="evidence"]');
      if (img) {
        const idx = parseInt(img.getAttribute('data-idx'), 10);
        const realItem = state.filtered[idx];
        if (realItem) openImage(realItem);
        return;
      }

      // Click en botones de acciones
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const idx = parseInt(btn.getAttribute('data-idx'), 10);
      const realItem = state.filtered[idx];
      if (!realItem) return;

      if (action === 'view') {
        openView(realItem);
      }
      if (action === 'edit' && canEdit(state.role)) {
        openEdit(realItem);
      }
      if (action === 'delete' && canDelete(state.role)) {
        doDelete(realItem);
      }
    });
    }

    function openView(r) {
      const box = document.getElementById('detail');
      const geoTxt = fmtGeo(r);
      const barreras = (r.barreras || '').toString();
      const marcaAsistida = (r.marca_asistida || '').toString();

      box.innerHTML = `
        <div class="detail">
          <div class="kv"><label>Fecha</label><div class="val">${fmtDate(r.ts)}</div></div>
          <div class="kv"><label>Encuestador</label><div class="val">${r.encuestador_id || '<span class="muted">N/A</span>'}</div></div>
          <div class="kv"><label>Zona</label><div class="val">${r.zona || '<span class="muted">N/A</span>'}</div></div>
          <div class="kv"><label>Edad</label><div class="val">${r.edad ?? ''}</div></div>
          <div class="kv"><label>Intenci√≥n (0‚Äì10)</label><div class="val">${r.intencion ?? ''}</div></div>
          <div class="kv"><label>Ubicaci√≥n</label><div class="val mono">${geoTxt}</div></div>

          <div class="kv full"><label>Comentarios</label><div class="val">${(r.comentarios || '').toString() || '<span class="muted">‚Äî</span>'}</div></div>
          <div class="kv full"><label>Barreras</label><div class="val">${barreras || '<span class="muted">‚Äî</span>'}</div></div>

          <div class="kv"><label>Marca considerada</label><div class="val">${(r.marca || '').toString() || '<span class="muted">‚Äî</span>'}</div></div>
          <div class="kv"><label>Awareness OMO</label><div class="val">${(r.awareness_omo || '').toString() || '<span class="muted">‚Äî</span>'}</div></div>

          ${r.image_proof_png ? `
            <div class="kv full">
              <label>Evidencia</label>
              <div class="img-wrap"><img src="${r.image_proof_png}" alt="evidencia"/></div>
            </div>
          ` : ''}
        </div>
      `;
      document.getElementById('viewModal').showModal();
    }
    function openImage(r) {
      const wrap = document.getElementById('imageWrap');
      wrap.innerHTML = r.image_proof_png
        ? `<img src="${r.image_proof_png}" alt="Evidencia"/>`
        : '<div class="muted">Sin imagen</div>';

      document.getElementById('img_encuestador').textContent = r.encuestador_id || '‚Äî';
      document.getElementById('img_fecha').textContent = fmtDate(r.ts);
      document.getElementById('img_geo').textContent =
        (r.geo_lat != null && r.geo_lng != null)
          ? `${Number(r.geo_lat).toFixed(5)}, ${Number(r.geo_lng).toFixed(5)}${r.geo_accuracy != null ? ' ¬±' + Math.round(r.geo_accuracy) + 'm' : ''}`
          : 'N/A';

      document.getElementById('imageModal').showModal();
    }
    function openEdit(r) {
      const idx = state.all.indexOf(r);
      state.editIndex = idx;
      document.getElementById('edit_edad').value = r.edad ?? '';
      document.getElementById('edit_intencion').value = r.intencion ?? '';
      document.getElementById('edit_zona').value = r.zona ?? '';
      document.getElementById('edit_comentarios').value = r.comentarios ?? '';
      document.getElementById('editModal').showModal();
    }

    async function doDelete(r) {
  if (!confirm('¬øEliminar esta encuesta? Esta acci√≥n no se puede deshacer.')) return;
  
  // LOGGING DETALLADO PARA DIAGN√ìSTICO
  console.group('üóëÔ∏è Intentando eliminar encuesta');
  console.log('Registro a eliminar:', r);
  console.log('Tiene _firestoreId?', r._firestoreId);
  console.log('Tiene _createdAt?', r._createdAt);
  console.log('Tiene ts?', r.ts);
  console.log('Tiene encuestador_id?', r.encuestador_id);
  console.log('Firebase disponible?', !!window.db);
  
   // Ya no usamos localStorage, solo Firestore
   let removedFromFirestore = false;

// Eliminar de Firestore
  if (window.db) {
    try {
      // M√©todo 1: Usar el ID del documento si est√° disponible (m√°s eficiente)
      if (r._firestoreId) {
        console.log('Usando _firestoreId:', r._firestoreId);
        await window.db.collection('surveys').doc(r._firestoreId).delete();
        removedFromFirestore = true;
        console.log('‚úì Eliminado de Firestore usando document ID');
      } 
      // M√©todo 2: Buscar por _createdAt (fallback)
      else if (r._createdAt) {
        console.log('Buscando por _createdAt:', r._createdAt);
        const snap = await window.db.collection('surveys')
          .where('_createdAt', '==', r._createdAt)
          .limit(1)
          .get();
        
        console.log('Resultados encontrados:', snap.size);
        if (!snap.empty) {
          await snap.docs[0].ref.delete();
          removedFromFirestore = true;
          console.log('‚úì Eliminado de Firestore usando query');
        } else {
          console.warn('‚ö† No encontrado en Firestore');
        }
      }
      // M√©todo 3: Buscar por timestamp y encuestador (√∫ltimo recurso)
      else if (r.ts && r.encuestador_id) {
        console.log('Buscando por ts+encuestador_id');
        const snap = await window.db.collection('surveys')
          .where('ts', '==', r.ts)
          .where('encuestador_id', '==', r.encuestador_id)
          .limit(1)
          .get();
        
        console.log('Resultados encontrados:', snap.size);
        if (!snap.empty) {
          await snap.docs[0].ref.delete();
          removedFromFirestore = true;
          console.log('‚úì Eliminado de Firestore usando ts+encuestador_id');
        } else {
          console.warn('‚ö† No encontrado en Firestore');
        }
      } else {
        console.warn('‚ö† No hay suficientes datos para buscar en Firestore');
      }
    } catch (e) {
      console.error('Error eliminando de Firestore:', e);
      alert(`Error al eliminar de Firestore: ${e.message}`);
    }
  } else {
    console.warn('‚ö† Firebase no disponible');
  }
  
  console.groupEnd();
  
  // 3. Mostrar resultado y refrescar
  if (removedFromFirestore) {
    loadData(); // refrescar
    alert('Encuesta eliminada de Firestore exitosamente');
  } else {
    alert('No se pudo eliminar la encuesta (no encontrada).');
  }
}

async function saveEdit() {
  const idx = state.editIndex;
  if (idx == null || idx < 0) { 
    document.getElementById('editModal').close(); 
    return; 
  }
  
  const ref = state.all[idx];
  if (!ref || !ref._firestoreId) {
    alert('No se pudo identificar la encuesta para editar.');
    return;
  }

  try {
    // Obtener valores del formulario
    const edad = Number(document.getElementById('edit_edad').value);
    const intencion = Number(document.getElementById('edit_intencion').value);
    const zona = document.getElementById('edit_zona').value;
    const comentarios = document.getElementById('edit_comentarios').value;

    // Actualizar en Firestore
    if (!window.db) {
      throw new Error('Firebase no disponible');
    }

    await window.db.collection('surveys').doc(ref._firestoreId).update({
      edad: edad || ref.edad,
      intencion: intencion || ref.intencion,
      zona: zona || ref.zona,
      comentarios: comentarios || ref.comentarios,
      _updatedAt: new Date().toISOString()
    });

    console.log('‚úì Encuesta actualizada en Firestore');
    document.getElementById('editModal').close();
    loadData();
    alert('Cambios guardados exitosamente.');
  } catch (err) {
    console.error('Error al actualizar encuesta:', err);
    alert(`Error al guardar cambios: ${err.message}`);
  }
}


    document.getElementById('saveEdit').addEventListener('click', saveEdit);

    function watchRoleReady() {
      let tries = 0;
      const iv = setInterval(() => {
        const prev = state.role;
        loadSession();
        if (state.role !== prev) {
          render();
        }
        if (state.role === 'admin' || state.role === 'supervisor' || ++tries >= 10) {
          clearInterval(iv);
        }
      }, 300);
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      if (window.AuthSystem && typeof AuthSystem.checkAuthOnProtectedPages === 'function') {
        AuthSystem.checkAuthOnProtectedPages();
      }

      loadSession();
      loadData();
      wireEvents();
      watchRoleReady();

      if (!canView(state.role)) {
        alert('No tienes permisos para acceder.');
        window.location.href = 'login.html';
      }
    });
  })();
  </script>

  <script>
    (function firebaseStatusBadge(){
      function ensureBadge() {
        const header = document.querySelector('.header') || document.body;
        if (!header) return;
        let el = document.getElementById('fb-status-badge');
        if (!el) {
          el = document.createElement('div');
          el.id = 'fb-status-badge';
          el.style.cssText = `
            position:absolute; top:10px; right:20px; z-index:9999;
            display:flex; align-items:center; gap:8px;
            background: rgba(255,255,255,0.95); border:1px solid #e5e7eb;
            padding:6px 10px; border-radius:999px; font: 12px Inter, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          `;
          header.style.position = 'relative';
          header.appendChild(el);
        }
        const ok = !!(window.db && window.fbAuth && window.fbAuth.currentUser);
        const email = window.fbAuth?.currentUser?.email || '‚Äî';
        el.innerHTML = `
          <span style="width:10px;height:10px;border-radius:999px;background:${ok ? '#16a34a' : '#ef4444'};display:inline-block;"></span>
          <span>${ok ? 'Firebase: Online' : 'Firebase: Offline'}</span>
          <span style="color:#64748b">(${email})</span>
        `;
      }
      // Intentos durante 5s para esperar fbAuth
      const deadline = Date.now() + 5000;
      (function tick(){
        ensureBadge();
        if (Date.now() < deadline && !(window.fbAuth && window.fbAuth.currentUser)) {
          setTimeout(tick, 300);
        }
      })();
      // Refresca ante cambios de auth si es posible
      if (window.fbAuth?.onAuthStateChanged) {
        window.fbAuth.onAuthStateChanged(() => ensureBadge());
      }
    })();
    </script>
</body>
</html>