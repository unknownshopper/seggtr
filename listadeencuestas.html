<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de encuestas — Omomobility</title>
  <link rel="icon" href="logcho.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 16px 0; }
    .search { min-width: 220px; }
  
    /* Tabla mejorada */
    table { width: 100%; border-collapse: collapse; background: var(--paper); border-radius: 12px; overflow: hidden; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { position: sticky; top: 0; z-index: 1; text-align: left; font-weight: 600; color: var(--muted); background: #f7f7f7; backdrop-filter: blur(4px); }
    tbody tr:nth-child(odd) { background: #fcfcfc; }
    tbody tr:hover { background: #fffbe6; }
  
    .actions { display: flex; gap: 6px; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .role-admin { background: #dc35451a; color: #dc3545; }
    .role-supervisor { background: #0d6efd1a; color: #0d6efd; }
    .role-encuestador { background: #6c757d1a; color: #6c757d; }
  
    .pagination { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    .muted { color: var(--muted); }
    .nowrap { white-space: nowrap; }
    .w100 { width: 100px; } .w120 { width: 120px; } .w160 { width: 160px; }
  
    /* Evidencia */
    .thumb { max-width: 120px; max-height: 80px; border: 1px solid var(--border); border-radius: 8px; transition: transform .15s ease, box-shadow .15s ease; }
    .thumb:hover { transform: scale(1.4); box-shadow: 0 6px 18px rgba(0,0,0,.15); }
  
    /* Celdas mejoradas */
    .cell-user { display: flex; align-items: center; gap: 8px; }
    .avatar {
      width: 28px; height: 28px; border-radius: 999px;
      background: #eef2ff; color: #4f46e5; font-weight: 700;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 12px; border: 1px solid #e5e7eb;
    }
    .chip {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      background: #f0fdf4; color: #16a34a; font-size: 12px; border: 1px solid #e2e8f0;
    }
    .num { text-align: center; font-variant-numeric: tabular-nums; }
    .geo { color: #64748b; font-size: 12px; }
  
    /* Barra de intención mini */
    .intent {
      display: inline-flex; align-items: center; gap: 6px;
    }
    .intent-bar {
      width: 90px; height: 8px; border-radius: 999px; background: #e5e7eb; overflow: hidden; border: 1px solid #e2e8f0;
    }
    .intent-fill {
      height: 100%; background: linear-gradient(90deg, #34d399, #10b981);
      width: 0%;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header" style="position: relative;">
      <img class="logo" src="logcho.png" alt="Omomobility" onerror="this.onerror=null; this.src='logch.png'"/>
      <div>
        <h1>Lista de encuestas</h1>
        <p class="lead">Consulta y gestiona hasta 250 encuestas desde Firebase (fallback: este dispositivo).</p>      </div>
      <div id="roleBadge" class="header-actions"></div>
    </header>

    <div class="toolbar">
      <input id="search" class="search" type="text" placeholder="Buscar por encuestador, zona, comentarios..." />
      <select id="pageSize" class="btn outline small">
        <option value="25">25 por página</option>
        <option value="50" selected>50 por página</option>
        <option value="100">100 por página</option>
      </select>
      <span id="countInfo" class="note"></span>
      <div class="header-actions">
        <a href="index.html" class="btn outline small">← Inicio</a>
        <a href="encuesta.html" class="btn small">Nueva encuesta</a>
      </div>
    </div>

    <button id="exportCsv" class="btn outline small">Exportar CSV</button>
<label class="btn outline small" style="cursor:pointer;">
  Importar CSV
  <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none;">
</label>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w160">Fecha</th>
            <th>Encuestador</th>
            <th>Zona</th>
            <th class="w100">Edad</th>
            <th class="w100">Intención</th>
            <th class="w120">Ubicación</th>
            <th>Evidencia</th>
            <th class="w160">Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="pagination">
        <button id="prev" class="btn outline small">Anterior</button>
        <span id="pageInfo" class="note"></span>
        <button id="next" class="btn outline small">Siguiente</button>
      </div>
    </div>
  </div>

  <dialog id="viewModal">
    <div class="modal">
      <h3>Detalle de encuesta</h3>
      <div id="detail"></div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('viewModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>
  <dialog id="imageModal">
    <div class="modal">
      <h3>Evidencia</h3>
      <div class="img-wrap" id="imageWrap"></div>
      <div class="detail" style="margin-top: 10px;">
        <div class="kv">
          <label>Encuestador</label>
          <div class="val" id="img_encuestador">—</div>
        </div>
        <div class="kv">
          <label>Fecha</label>
          <div class="val" id="img_fecha">—</div>
        </div>
        <div class="kv">
          <label>Ubicación</label>
          <div class="val mono" id="img_geo">—</div>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn" onclick="document.getElementById('imageModal').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <dialog id="editModal">
    <div class="modal">
      <h3>Editar encuesta</h3>
      <div class="grid-2">
        <div class="field">
          <label>Edad</label>
          <input id="edit_edad" type="number" min="15" max="80"/>
        </div>
        <div class="field">
          <label>Intención (0–10)</label>
          <input id="edit_intencion" type="number" min="0" max="10"/>
        </div>
        <div class="field">
          <label>Zona</label>
          <input id="edit_zona" type="text" />
        </div>
        <div class="field">
          <label>Comentarios</label>
          <textarea id="edit_comentarios" rows="2"></textarea>
        </div>
      </div>
      <div class="right" style="margin-top: 12px;">
        <button class="btn outline" onclick="document.getElementById('editModal').close()">Cancelar</button>
        <button id="saveEdit" class="btn">Guardar</button>
      </div>
    </div>
  </dialog>

  <script src="data-manager.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Config e inicialización -->
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script>
  (function() {
    const MAX = 250; // mostrar máximo 250
    const state = {
      role: 'encuestador',
      page: 1,
      pageSize: 50,
      filtered: [],
      all: [],
      editIndex: null
    };

    function getRoleBadge(role) {
      const cls = role === 'admin' ? 'role-admin' : role === 'supervisor' ? 'role-supervisor' : 'role-encuestador';
      return '<span class="pill ' + cls + '">' + role + '</span>';
    }

    function canView(role) { return ['admin', 'supervisor', 'encuestador'].includes(role); }
    function canEdit(role) { return role === 'admin'; }
    function canDelete(role) { return role === 'admin'; }

    function loadSession() {
  const prev = state.role;
  let role = 'encuestador';

  try {
    if (window.AuthSystem && typeof AuthSystem.getSession === 'function') {
      const s = AuthSystem.getSession();
      if (s?.role) role = s.role;
      if ((s?.username || '').toLowerCase() === 'admin') {
        role = 'admin';
      }
    } else {
      // fallback al localStorage directo
      const raw = localStorage.getItem('omomobility_session');
      if (raw) {
        const sess = JSON.parse(raw);
        role = sess?.role || role;
        if ((sess?.username || '').toLowerCase() === 'admin') {
          role = 'admin';
        }
      }
    }
  } catch(_) {}

  state.role = role;

  const badge = document.getElementById('roleBadge');
  if (badge) {
    badge.innerHTML = '<span class="muted">Rol:</span> ' + getRoleBadge(state.role);
  }

  if (state.role !== prev) {
    render();
  }
}

function loadData() {
  const fallback = () => {
    const rows = DataManager.readAll() || [];
    state.all = rows.slice(0, MAX);
    applyFilter();
  };

  if (window.db) {
    fetchFromFirestore().then(rows => {
      if (Array.isArray(rows) && rows.length) {
        state.all = rows.slice(0, MAX);
        applyFilter();
      } else {
        fallback();
      }
    }).catch(() => {
      fallback();
    });
  } else {
    fallback();
  }
}

async function fetchFromFirestore() {
  try {
    const colRef = window.db.collection('surveys');
    // Si tienes _createdAt puedes ordenar (creará índice si lo pide):
    // const snap = await colRef.orderBy('_createdAt', 'desc').limit(250).get();
    const snap = await colRef.limit(250).get();
    const rows = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      if (d._probe) return; // omitir registros de prueba

      rows.push({
        // fecha normalizada
        ts: d.ts || d._createdAt || d.when || null,
        // campos estándar del formulario
        encuestador_id: d.encuestador_id || '',
        zona: d.zona || 'Sin especificar',
        edad: d.edad ?? '',
        intencion: d.intencion ?? '',
        comentarios: d.comentarios || '',
        // geolocalización
        geo_lat: d.geo_lat ?? null,
        geo_lng: d.geo_lng ?? null,
        geo_accuracy: d.geo_accuracy ?? null,
        // evidencia
        image_proof_png: d.image_proof_png || null,
        // deja pasar cualquier otro campo que uses
        ...d
      });
    });
    console.log('[Dashboard] Firestore rows:', rows.length, rows[0] ? Object.keys(rows[0]) : 'no rows');
    return rows;
  } catch (e) {
    console.warn('Firestore read failed:', e?.message || e);
    return [];
  }
}

    function applyFilter() {
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      const list = state.all.filter(r => {
        const hay = (v) => (v ?? '').toString().toLowerCase().includes(q);
        return !q ||
          hay(r.encuestador_id) ||
          hay(r.zona) ||
          hay(r.comentarios) ||
          hay(r.ts);
      });
      state.filtered = list;
      state.page = 1;
      render();
    }

    function paginate(arr) {
      const start = (state.page - 1) * state.pageSize;
      return arr.slice(start, start + state.pageSize);
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
    }

    function fmtGeo(r) {
      if (r.geo_lat == null || r.geo_lng == null) return '<span class=\"muted\">N/A</span>';
      const acc = (r.geo_accuracy != null) ? ` ±${Math.round(r.geo_accuracy)}m` : '';
      return `${Number(r.geo_lat).toFixed(5)}, ${Number(r.geo_lng).toFixed(5)}${acc}`;
    }

    function render() {
      const total = state.filtered.length;
      const pages = Math.max(1, Math.ceil(total / state.pageSize));
      state.page = Math.min(state.page, pages);

      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';

      const pageRows = paginate(state.filtered);
      pageRows.forEach((r, i) => {
        const idx = (state.page - 1) * state.pageSize + i; // índice real en filtered
        // Enlace a evidencia (thumbnail inline si existe)
        const evidence = r.image_proof_png
          ? `<img class="thumb" src="${r.image_proof_png}" alt="evidencia" />`
          : `<span class="muted">Sin imagen</span>`;

        const actions = [];
        actions.push(`<button class="btn outline small" data-action="view" data-idx="${idx}">Ver</button>`);
        if (canEdit(state.role)) actions.push(`<button class="btn outline small" data-action="edit" data-idx="${idx}">Editar</button>`);
        if (canDelete(state.role)) actions.push(`<button class="btn outline small" style="color:#e53e3e;border-color:#e53e3e" data-action="delete" data-idx="${idx}">Eliminar</button>`);

        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="nowrap">${fmtDate(r.ts)}</td>
        <td>
          <div class="cell-user">
            <span class="avatar">${(r.encuestador_id || 'NA').toString().trim().slice(0,2).toUpperCase()}</span>
            <span>${r.encuestador_id || '<span class="muted">N/A</span>'}</span>
          </div>
        </td>
        <td><span class="chip">${(r.zona || 'Sin especificar')}</span></td>
        <td class="num">${r.edad ?? ''}</td>
        <td class="num">
          <div class="intent">
            <div class="intent-bar"><div class="intent-fill" style="width: ${Math.max(0, Math.min(100, Number(r.intencion || 0) * 10))}%;"></div></div>
            <span>${r.intencion ?? ''}</span>
          </div>
        </td>
        <td class="nowrap"><span class="geo">${fmtGeo(r)}</span></td>
<td>
  ${r.image_proof_png
    ? `<img class="thumb" src="${r.image_proof_png}" alt="evidencia" data-action="evidence" data-idx="${idx}" />`
    : `<span class="muted">Sin imagen</span>`}
</td>        <td><div class="actions">${actions.join('')}</div></td>
      `;
        tbody.appendChild(tr);
      });

      document.getElementById('pageInfo').textContent = `Página ${state.page} de ${pages}`;
      document.getElementById('countInfo').textContent = `${total} encuestas (mostrando máx. ${MAX})`;
      document.getElementById('prev').disabled = state.page <= 1;
      document.getElementById('next').disabled = state.page >= pages;
    }

    function wireEvents() {
      document.getElementById('search').addEventListener('input', () => applyFilter());
      document.getElementById('pageSize').addEventListener('change', (e) => {
        state.pageSize = parseInt(e.target.value, 10) || 50;
        render();
      });
      document.getElementById('prev').addEventListener('click', () => { state.page = Math.max(1, state.page - 1); render(); });
      document.getElementById('next').addEventListener('click', () => {
        const total = state.filtered.length;
        const pages = Math.max(1, Math.ceil(total / state.pageSize));
        state.page = Math.min(pages, state.page + 1);
        render();
      });

      document.getElementById('rows').addEventListener('click', (e) => {
      // Click en evidencia (imagen)
      const img = e.target.closest('img.thumb[data-action="evidence"]');
      if (img) {
        const idx = parseInt(img.getAttribute('data-idx'), 10);
        const realItem = state.filtered[idx];
        if (realItem) openImage(realItem);
        return;
      }

      // Click en botones de acciones
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const idx = parseInt(btn.getAttribute('data-idx'), 10);
      const realItem = state.filtered[idx];
      if (!realItem) return;

      if (action === 'view') {
        openView(realItem);
      }
      if (action === 'edit' && canEdit(state.role)) {
        openEdit(realItem);
      }
      if (action === 'delete' && canDelete(state.role)) {
        doDelete(realItem);
      }
    });
    }

    function openView(r) {
      const box = document.getElementById('detail');
      const geoTxt = fmtGeo(r);
      const barreras = (r.barreras || '').toString();
      const marcaAsistida = (r.marca_asistida || '').toString();

      box.innerHTML = `
        <div class="detail">
          <div class="kv"><label>Fecha</label><div class="val">${fmtDate(r.ts)}</div></div>
          <div class="kv"><label>Encuestador</label><div class="val">${r.encuestador_id || '<span class="muted">N/A</span>'}</div></div>
          <div class="kv"><label>Zona</label><div class="val">${r.zona || '<span class="muted">N/A</span>'}</div></div>
          <div class="kv"><label>Edad</label><div class="val">${r.edad ?? ''}</div></div>
          <div class="kv"><label>Intención (0–10)</label><div class="val">${r.intencion ?? ''}</div></div>
          <div class="kv"><label>Ubicación</label><div class="val mono">${geoTxt}</div></div>

          <div class="kv full"><label>Comentarios</label><div class="val">${(r.comentarios || '').toString() || '<span class="muted">—</span>'}</div></div>
          <div class="kv full"><label>Barreras</label><div class="val">${barreras || '<span class="muted">—</span>'}</div></div>

          <div class="kv"><label>Marca considerada</label><div class="val">${(r.marca || '').toString() || '<span class="muted">—</span>'}</div></div>
          <div class="kv"><label>Awareness OMO</label><div class="val">${(r.awareness_omo || '').toString() || '<span class="muted">—</span>'}</div></div>

          ${r.image_proof_png ? `
            <div class="kv full">
              <label>Evidencia</label>
              <div class="img-wrap"><img src="${r.image_proof_png}" alt="evidencia"/></div>
            </div>
          ` : ''}
        </div>
      `;
      document.getElementById('viewModal').showModal();
    }
    function openImage(r) {
      const wrap = document.getElementById('imageWrap');
      wrap.innerHTML = r.image_proof_png
        ? `<img src="${r.image_proof_png}" alt="Evidencia"/>`
        : '<div class="muted">Sin imagen</div>';

      document.getElementById('img_encuestador').textContent = r.encuestador_id || '—';
      document.getElementById('img_fecha').textContent = fmtDate(r.ts);
      document.getElementById('img_geo').textContent =
        (r.geo_lat != null && r.geo_lng != null)
          ? `${Number(r.geo_lat).toFixed(5)}, ${Number(r.geo_lng).toFixed(5)}${r.geo_accuracy != null ? ' ±' + Math.round(r.geo_accuracy) + 'm' : ''}`
          : 'N/A';

      document.getElementById('imageModal').showModal();
    }
    function openEdit(r) {
      const idx = state.all.indexOf(r);
      state.editIndex = idx;
      document.getElementById('edit_edad').value = r.edad ?? '';
      document.getElementById('edit_intencion').value = r.intencion ?? '';
      document.getElementById('edit_zona').value = r.zona ?? '';
      document.getElementById('edit_comentarios').value = r.comentarios ?? '';
      document.getElementById('editModal').showModal();
    }

    function doDelete(r) {
      if (!confirm('¿Eliminar esta encuesta? Esta acción no se puede deshacer.')) return;
      const all = DataManager.readAll();
      const pos = all.indexOf(r);
      // Si no encontró por referencia (por recreación), hacemos match por ts+encuestador_id
      let removed = false;
      if (pos >= 0) {
        all.splice(pos, 1);
        removed = true;
      } else {
        const idx = all.findIndex(x => x.ts === r.ts && x.encuestador_id === r.encuestador_id);
        if (idx >= 0) { all.splice(idx, 1); removed = true; }
      }
      if (removed) {
        DataManager.writeAll(all);
        loadData(); // refrescar
        alert('Encuesta eliminada.');
      } else {
        alert('No se pudo eliminar (no encontrada).');
      }
    }

    function saveEdit() {
      const idx = state.editIndex;
      if (idx == null || idx < 0) { document.getElementById('editModal').close(); return; }
      const all = DataManager.readAll();
      // Buscar por ts+encuestador_id para mayor robustez
      const ref = state.all[idx];
      const real = all.find(x => x.ts === ref.ts && x.encuestador_id === ref.encuestador_id);
      if (!real) { alert('No se pudo guardar, registro no encontrado.'); return; }

      real.edad = Number(document.getElementById('edit_edad').value) || real.edad;
      real.intencion = Number(document.getElementById('edit_intencion').value) || real.intencion;
      real.zona = document.getElementById('edit_zona').value || real.zona;
      real.comentarios = document.getElementById('edit_comentarios').value || real.comentarios;

      DataManager.writeAll(all);
      document.getElementById('editModal').close();
      loadData();
      alert('Cambios guardados.');
    }

    document.getElementById('saveEdit').addEventListener('click', saveEdit);


    function watchRoleReady() {
  let tries = 0;
  const iv = setInterval(() => {
    const prev = state.role;
    loadSession();            // vuelve a leer AuthSystem.getSession()
    if (state.role !== prev) {
      render();               // re-dibuja acciones según nuevo rol
    }
    // corta si ya resolvió o tras ~3s (10*300ms)
    if (state.role === 'admin' || state.role === 'supervisor' || ++tries >= 10) {
      clearInterval(iv);
    }
  }, 300);
}


  // Inicialización
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Enforce auth/role mapping (redirige si no puede entrar)
    if (window.AuthSystem && typeof AuthSystem.checkAuthOnProtectedPages === 'function') {
      AuthSystem.checkAuthOnProtectedPages();
    }

    // 2) Cargar sesión/tabla/eventos
    loadSession();
    loadData();
    wireEvents();

    // 3) Observa actualización de rol hasta que esté listo (por si la sesión llega tarde)
    watchRoleReady();

    // 4) Defensa extra (si no puede ver, salir)
    if (!canView(state.role)) {
      alert('No tienes permisos para acceder.');
      window.location.href = 'login.html';
    }
  });
})();
  </script>
  <script>
    (function firebaseStatusBadge(){
      function ensureBadge() {
        const header = document.querySelector('.header') || document.body;
        if (!header) return;
        let el = document.getElementById('fb-status-badge');
        if (!el) {
          el = document.createElement('div');
          el.id = 'fb-status-badge';
          el.style.cssText = `
            position:absolute; top:10px; right:20px; z-index:9999;
            display:flex; align-items:center; gap:8px;
            background: rgba(255,255,255,0.95); border:1px solid #e5e7eb;
            padding:6px 10px; border-radius:999px; font: 12px Inter, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          `;
          header.style.position = 'relative';
          header.appendChild(el);
        }
        const ok = !!(window.db && window.fbAuth && window.fbAuth.currentUser);
        const email = window.fbAuth?.currentUser?.email || '—';
        el.innerHTML = `
          <span style="width:10px;height:10px;border-radius:999px;background:${ok ? '#16a34a' : '#ef4444'};display:inline-block;"></span>
          <span>${ok ? 'Firebase: Online' : 'Firebase: Offline'}</span>
          <span style="color:#64748b">(${email})</span>
        `;
      }
      // Intentos durante 5s para esperar fbAuth
      const deadline = Date.now() + 5000;
      (function tick(){
        ensureBadge();
        if (Date.now() < deadline && !(window.fbAuth && window.fbAuth.currentUser)) {
          setTimeout(tick, 300);
        }
      })();
      // Refresca ante cambios de auth si es posible
      if (window.fbAuth?.onAuthStateChanged) {
        window.fbAuth.onAuthStateChanged(() => ensureBadge());
      }
    })();
    </script>
</body>
</html>