<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEGGTR - Encuestador</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="#" aria-current="page">Encuestador</a></li>
      </ul>
    </nav>
    <h1>Panel del Encuestador</h1>
  </header>
  <main class="grid cols-2">
    <section class="card">
      <h2>Estado</h2>
      <p class="small muted">Usuario y geolocalización</p>
      <div id="user-info" class="small"></div>
      <div id="geo" class="small"></div>
      <button id="refresh-geo">Actualizar ubicación</button>
    </section>

    <section class="card">
      <h2>Encuesta rápida</h2>
      <form id="quick-form" class="grid">
        <label>
          ¿Interés en motos eléctricas?
          <select id="q_interest">
            <option value="alto">Alto</option>
            <option value="medio">Medio</option>
            <option value="bajo">Bajo</option>
          </select>
        </label>
        <label>
          Comentarios
          <input id="q_comment" placeholder="Opcional">
        </label>
        <button type="submit">Guardar respuesta</button>
        <div id="save-status" class="small muted"></div>
      </form>
    </section>
  </main>

  <footer>
    <p class="small muted"> 2025 SEGGTR</p>
  </footer>

  <!-- Firebase SDKs for local dev; Hosting injects config via /__/firebase/init.js -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script>
    // Inicialización segura:
    // - En Hosting, /__/firebase/init.js inyecta firebaseConfig automáticamente.
    // - En dev local (sin Hosting), cargamos /config/firebase.local.json (gitignored).
    let auth, db;
    const tenantId = 'omobility';
    let currentUser = null;
    let lastGeo = null;

    window.addEventListener('load', async ()=>{
      if (!firebase.apps.length) {
        try {
          const res = await fetch('/config/firebase.local.json', { cache: 'no-store' });
          if (res.ok) {
            const cfg = await res.json();
            firebase.initializeApp(cfg);
          }
        } catch(e) { /* ignore */ }
      }
      if (!firebase.apps.length) {
        console.error('Firebase no está inicializado. Usa Firebase Hosting o agrega config/firebase.local.json.');
        return;
      }
      auth = firebase.auth();
      db = firebase.firestore();
      bootstrap();
    });

    function show(el, msg){ document.getElementById(el).textContent = msg; }

    function bootstrap(){
      auth.onAuthStateChanged(async (user)=>{
        if (!user){ window.location.href = 'index.html'; return; }
        currentUser = user;
        const profile = await db.collection('users').doc(user.uid).get();
        const role = (profile.exists && profile.data().role) || 'surveyor';
        if (role === 'admin'){
          // Admins también pueden encuestar; opcionalmente redirigir
        }
        show('user-info', `Usuario: ${user.email || user.uid} | Rol: ${role}`);
        await updateGeo();
      });
    }

    async function updateGeo(){
      show('geo','Obteniendo ubicación...');
      const position = await new Promise((resolve)=>{
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(resolve, ()=>resolve(null), { enableHighAccuracy:true, timeout:8000 });
      });
      if(!position){ show('geo','Geolocalización no disponible'); return; }
      lastGeo = { lat: position.coords.latitude, lng: position.coords.longitude, accuracy: position.coords.accuracy };
      show('geo', `Lat: ${lastGeo.lat.toFixed(5)}, Lng: ${lastGeo.lng.toFixed(5)} (±${Math.round(lastGeo.accuracy)}m)`);
    }

    document.getElementById('refresh-geo').addEventListener('click', updateGeo);

    document.getElementById('quick-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const el = document.getElementById('save-status');
      el.textContent = 'Guardando...';
      try{
        const payload = {
          tenantId,
          uid: currentUser.uid,
          email: currentUser.email || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          localTime: new Date().toISOString(),
          geo: lastGeo || null,
          answers: {
            interest: document.getElementById('q_interest').value,
            comment: document.getElementById('q_comment').value.trim() || null
          },
          meta: { userAgent: navigator.userAgent }
        };
        await db.collection('responses').add(payload);
        el.textContent = 'Respuesta guardada';
      }catch(e){ el.textContent = 'Error: '+e.message; }
    });
  </script>
</body>
</html>
