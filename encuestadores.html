<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Equipo de Encuestadores ‚Äî Omomobility</title>
  <link rel="icon" href="logcho.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 16px; }
    
    .encuestadores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }
    
    .encuestador-card {
      background: var(--paper);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .encuestador-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .foto-perfil {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      display: block;
      border: 4px solid #f0f0f0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .encuestador-card h3 {
      text-align: center;
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    
    .email {
      text-align: center;
      color: #667eea;
      font-size: 13px;
      margin: 0 0 4px 0;
      font-weight: 500;
    }
    
    .profesion {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 4px 0;
    }
    
    .edad {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 16px 0;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 20px 0;
      padding: 16px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    
    .stat {
      text-align: center;
    }
    
    .stat .number {
      display: block;
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 4px;
    }
    
    .stat .label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .device-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
    }
    
    .device-info p {
      margin: 4px 0;
      color: var(--text);
    }
    
    .device-info strong {
      color: var(--muted);
      font-weight: 500;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    
    .badge.active {
      background: #d4edda;
      color: #155724;
    }
    
    .badge.inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .placeholder-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <img class="logo" src="logcho.png" alt="Omomobility" onerror="this.onerror=null; this.src='logch.png'"/>
      <div>
        <h1 id="pageTitle">Equipo de Encuestadores</h1>
        <p class="lead" id="pageSubtitle">Profesionales capacitados para el estudio de mercado de motocicletas el√©ctricas en Villahermosa, Tabasco.</p>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn outline">‚Üê Inicio</a>
        <a href="listadeencuestas.html" class="btn">Ver encuestas</a>
      </div>
    </header>

    <div class="encuestadores-grid" id="encuestadoresGrid">
      <!-- Encuestador 1: M√°ximo Garc√≠a Dorame -->
      <div class="encuestador-card" data-encuestador="encuestador" data-email="encuestador@omobility.com">
        <div class="gafete-badge hidden">üé´ Gafete Digital</div>
        <img src="encuestadores/maximo.png" alt="M√°ximo Garc√≠a Dorame" class="foto-perfil" />        
        <h3>M√°ximo Garc√≠a Dorame</h3>
        <p class="email">encuestador@omobility.com</p>
        <p class="profesion">Estudiante de Contadur√≠a</p>
        <p class="edad">20 a√±os</p>
        <span class="badge active">‚óè Activo</span>
        
        <div class="stats">
          <div class="stat">
            <span class="number" id="enc1-total">0</span>
            <span class="label">Encuestas</span>
          </div>
          <div class="stat">
            <span class="number" id="enc1-precision">--</span>
            <span class="label">Precisi√≥n GPS</span>
          </div>
          <div class="stat">
            <span class="number" id="enc1-zonas">0</span>
            <span class="label">Zonas</span>
          </div>
        </div>
        
        <div class="device-info">
          <p><strong>Dispositivo:</strong> <span id="enc1-device">Detectando...</span></p>
          <p><strong>√öltima actividad:</strong> <span id="enc1-lastActivity">--</span></p>
        </div>
      </div>

      <!-- Encuestador 2: Humberto Castillo -->
      <div class="encuestador-card" data-encuestador="encuestador2" data-email="encuestador2@omobility.com">
        <div class="gafete-badge hidden">üé´ Gafete Digital</div>
        <img src="encuestadores/humberto.png" alt="Humberto Castillo" class="foto-perfil" />        
        <h3>Humberto Castillo</h3>
        <p class="email">encuestador2@omobility.com</p>
        <p class="profesion">Estudiante de Administraci√≥n</p>
        <p class="edad">23 a√±os</p>
        <span class="badge active">‚óè Activo</span>
        
        <div class="stats">
          <div class="stat">
            <span class="number" id="enc2-total">0</span>
            <span class="label">Encuestas</span>
          </div>
          <div class="stat">
            <span class="number" id="enc2-precision">--</span>
            <span class="label">Precisi√≥n GPS</span>
          </div>
          <div class="stat">
            <span class="number" id="enc2-zonas">0</span>
            <span class="label">Zonas</span>
          </div>
        </div>
        
        <div class="device-info">
          <p><strong>Dispositivo:</strong> <span id="enc2-device">--</span></p>
          <p><strong>√öltima actividad:</strong> <span id="enc2-lastActivity">--</span></p>
        </div>
      </div>

      <!-- Encuestador 3: Ar√≠stides Prats -->
      <div class="encuestador-card" data-encuestador="encuestador3" data-email="encuestador3@omobility.com">
        <div class="gafete-badge hidden">üé´ Gafete Digital</div>
        <img src="encuestadores/aristides.png" alt="Ar√≠stides Prats" class="foto-perfil" />        
        <h3>Ar√≠stides Prats</h3>
        <p class="email">encuestador3@omobility.com</p>
        <p class="profesion">Estudiante de Pol√≠ticas P√∫blicas</p>
        <p class="edad">24 a√±os</p>
        <span class="badge active">‚óè Activo</span>
        
        <div class="stats">
          <div class="stat">
            <span class="number" id="enc3-total">0</span>
            <span class="label">Encuestas</span>
          </div>
          <div class="stat">
            <span class="number" id="enc3-precision">--</span>
            <span class="label">Precisi√≥n GPS</span>
          </div>
          <div class="stat">
            <span class="number" id="enc3-zonas">0</span>
            <span class="label">Zonas</span>
          </div>
        </div>
        
        <div class="device-info">
          <p><strong>Dispositivo:</strong> <span id="enc3-device">--</span></p>
          <p><strong>√öltima actividad:</strong> <span id="enc3-lastActivity">--</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
   <!-- Sistema de autenticaci√≥n -->
  <script src="auth.js"></script>
  <script src="data-manager.js"></script>
  <script>
    // Funci√≥n para mostrar gafete seg√∫n usuario logueado
    function setupGafeteView() {
      const session = AuthSystem.getSession();
      if (!session) {
        console.log('[Gafete] No hay sesi√≥n activa');
        return;
      }

      const username = (session.username || '').toLowerCase();
      const role = (session.role || '').toLowerCase();
      const grid = document.getElementById('encuestadoresGrid');
      const cards = document.querySelectorAll('.encuestador-card');
      const pageTitle = document.getElementById('pageTitle');
      const pageSubtitle = document.getElementById('pageSubtitle');

      console.log('[Gafete] Usuario:', username, 'Rol:', role);

      // Si es admin, mostrar todos
      if (role === 'admin') {
        console.log('[Gafete] Admin - mostrando todos los encuestadores');
        cards.forEach(card => card.classList.remove('hidden'));
        grid.classList.remove('modo-gafete');
        pageTitle.textContent = 'Equipo de Encuestadores';
        pageSubtitle.textContent = 'Profesionales capacitados para el estudio de mercado de motocicletas el√©ctricas en Villahermosa, Tabasco.';
        return;
      }

      // Para encuestadores, mostrar solo su gafete
      let found = false;
      cards.forEach(card => {
        const cardEncuestador = card.getAttribute('data-encuestador');
        const cardEmail = card.getAttribute('data-email');
        
        // Verificar si coincide con el usuario actual
        const isMatch = 
          cardEncuestador === username ||
          cardEmail === session.email ||
          cardEmail === `${username}@omobility.com`;

        if (isMatch) {
          card.classList.remove('hidden');
          card.querySelector('.gafete-badge').classList.remove('hidden');
          found = true;
          console.log('[Gafete] Mostrando gafete para:', cardEncuestador);
        } else {
          card.classList.add('hidden');
        }
      });

      if (found) {
        grid.classList.add('modo-gafete');
        pageTitle.textContent = 'Mi Gafete Digital';
        pageSubtitle.textContent = 'Credencial de encuestador - Proyecto Omomobility';
      } else {
        console.warn('[Gafete] No se encontr√≥ tarjeta para usuario:', username);
      }
    }


// Variable global para controlar reintentos
let loadStatsRetries = 0;
const MAX_RETRIES = 3;

async function loadEncuestadorStats() {
  try {
    // Esperar a que Firebase est√© listo usando el evento
    if (!window.firebaseReady || !window.fbAuth || !window.fbAuth.currentUser) {
      if (loadStatsRetries < MAX_RETRIES) {
        console.log('[Encuestadores] Esperando Firebase... (intento ' + (loadStatsRetries + 1) + ')');
        loadStatsRetries++;
        setTimeout(loadEncuestadorStats, 2000); // Aumentar a 2 segundos
        return;
      } else {
        console.warn('[Encuestadores] ‚ö†Ô∏è Firebase no disponible despu√©s de varios intentos');
        return;
      }
    }

    // Reset contador de reintentos cuando conecta exitosamente
    loadStatsRetries = 0;

    // Intentar cargar desde Firestore con timeout y cache
    let surveys = [];
    if (window.db) {
      try {
        // Usar cache primero para reducir llamadas al servidor
        const snap = await window.db.collection('surveys')
          .limit(250)
          .get({ source: 'cache' })
          .catch(() => {
            // Si falla el cache, intentar servidor
            return window.db.collection('surveys').limit(250).get({ source: 'server' });
          });
        
        surveys = snap.docs.map(doc => ({
          ...doc.data(),
          _firestoreId: doc.id
        }));
        
        console.log(`[Encuestadores] ‚úÖ Cargadas ${surveys.length} encuestas`);
      } catch (firestoreError) {
        console.warn('[Encuestadores] ‚ö†Ô∏è Error de Firestore:', firestoreError.code || firestoreError.message);
        
        // Fallback a localStorage si Firestore falla
        if (window.DataManager && typeof DataManager.readAll === 'function') {
          surveys = DataManager.readAll() || [];
          console.log(`[Encuestadores] Usando localStorage: ${surveys.length} encuestas`);
        }
      }
    }

    if (surveys.length === 0) {
      console.warn('[Encuestadores] ‚ö†Ô∏è No hay encuestas disponibles');
      document.querySelectorAll('[id$="-total"]').forEach(el => el.textContent = '0');
      return;
    }

        // Funci√≥n para identificar encuestador de forma flexible (igual que listadeencuestas-core.js)
        function identifyEncuestador(survey) {
      // Priorizar _createdEmail si encuestador_id es gen√©rico
      const emailToUse = (survey.encuestador_id === 'Encuestador' || survey.encuestador_id === 'encuestador') 
        ? survey._createdEmail 
        : survey.encuestador_id;
      
      if (!emailToUse) return null;
      
      const id = String(emailToUse).toLowerCase().trim();
      
      // Encuestador 1 (M√°ximo Garc√≠a)
      if (id === 'encuestador' || 
          id === 'encuestador@omobility.com' ||
          id === 'encuestador 1' ||
          id === 'encuestador1' ||
          id.includes('maximo') ||
          id.includes('m√°ximo') ||
          id.includes('garcia')) {
        return 'enc1';
      }
      
      // Encuestador 2 (Humberto Castillo)
      if (id === 'encuestador2' || 
          id === 'encuestador2@omobility.com' ||
          id === 'encuestador 2' ||
          id.includes('humberto') ||
          id.includes('castillo')) {
        return 'enc2';
      }

      // Encuestador 3 (Ar√≠stides Prats)
      if (id === 'encuestador3' || 
          id === 'encuestador3@omobility.com' ||
          id === 'encuestador 3' ||
          id.includes('aristides') ||
          id.includes('ar√≠stides') ||
          id.includes('prats')) {
        return 'enc3';
      }
      
      return null;
    }


    // Agrupar por encuestador
    const stats = {
      enc1: { total: 0, zonas: new Set(), precisions: [], lastActivity: null },
      enc2: { total: 0, zonas: new Set(), precisions: [], lastActivity: null },
      enc3: { total: 0, zonas: new Set(), precisions: [], lastActivity: null }
    };

    surveys.forEach(s => {
      const encId = identifyEncuestador(s);
        if (!encId) {
        // Solo loguear en desarrollo
        if (window.location.hostname === 'localhost') {
          console.log('[Encuestadores] No identificado:', s.encuestador_id, '| Email:', s._createdEmail);
        }
        return;
      }

      stats[encId].total++;
      if (s.zona) stats[encId].zonas.add(s.zona);
      if (s.geo_accuracy != null) stats[encId].precisions.push(s.geo_accuracy);
      
      const ts = new Date(s.ts || s._createdAt);
      if (!stats[encId].lastActivity || ts > stats[encId].lastActivity) {
        stats[encId].lastActivity = ts;
      }
    });

    // Actualizar UI
    Object.keys(stats).forEach(encId => {
      const data = stats[encId];
      
      const totalEl = document.getElementById(`${encId}-total`);
      const zonasEl = document.getElementById(`${encId}-zonas`);
      const precisionEl = document.getElementById(`${encId}-precision`);
      const activityEl = document.getElementById(`${encId}-lastActivity`);
      
      if (!totalEl) return; // Skip si el elemento no existe (card oculta)
      
      // Total encuestas
      totalEl.textContent = data.total;
      
      // Zonas cubiertas
      if (zonasEl) zonasEl.textContent = data.zonas.size;
      
      // Precisi√≥n GPS promedio
      if (precisionEl && data.precisions.length > 0) {
        const avgPrecision = data.precisions.reduce((a, b) => a + b, 0) / data.precisions.length;
        precisionEl.textContent = `¬±${Math.round(avgPrecision)}m`;
      }
      
      // √öltima actividad
      if (activityEl && data.lastActivity) {
        const now = new Date();
        const diff = now - data.lastActivity;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);
        
        let timeStr;
        if (days > 0) timeStr = `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
        else if (hours > 0) timeStr = `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
        else timeStr = 'Hace menos de 1 hora';
        
        activityEl.textContent = timeStr;
      }
    });

    console.log('[Encuestadores] ‚úÖ Estad√≠sticas actualizadas');
  } catch (e) {
    console.error('[Encuestadores] ‚ùå Error cargando estad√≠sticas:', e);
  }
}

    // Detectar dispositivo del navegador actual
    function detectDevice() {
      const ua = navigator.userAgent;
      let device = 'Desconocido';
      
      if (/iPhone/.test(ua)) device = 'iPhone';
      else if (/iPad/.test(ua)) device = 'iPad';
      else if (/Android/.test(ua)) {
        if (/Mobile/.test(ua)) device = 'Android Phone';
        else device = 'Android Tablet';
      } else if (/Windows/.test(ua)) device = 'PC Windows';
      else if (/Mac/.test(ua)) device = 'Mac';
      else if (/Linux/.test(ua)) device = 'Linux';
      
      // Actualizar dispositivo para todas las tarjetas visibles
      const session = AuthSystem.getSession();
      if (session) {
        const username = (session.username || '').toLowerCase();
        
        // Mapear username a ID de encuestador
        let encId = 'enc1'; // default
        if (username === 'encuestador2') encId = 'enc2';
        else if (username === 'encuestador3') encId = 'enc3';
        
        const deviceEl = document.getElementById(`${encId}-device`);
        if (deviceEl) deviceEl.textContent = device;
      }
    }

  // Cargar al inicio
  document.addEventListener('DOMContentLoaded', () => {
    setupGafeteView();
    detectDevice();
    
    // Esperar evento de Firebase listo
    if (window.firebaseReady) {
      loadEncuestadorStats();
    } else {
      window.addEventListener('firebaseReady', () => {
        console.log('[Encuestadores] Firebase listo, cargando stats...');
        loadEncuestadorStats();
      }, { once: true });
    }
    
    // Recargar cada 60 segundos (aumentado de 30 para reducir carga)
    setInterval(loadEncuestadorStats, 60000);
  });
  </script>

   <!-- Firebase SDK -->
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
   
   <!-- Config e inicializaci√≥n de Firebase -->
   <script src="firebase-config.js"></script>
</body>
</html>